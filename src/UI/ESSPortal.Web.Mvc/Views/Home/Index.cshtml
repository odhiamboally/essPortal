@model DashboardViewModel

@{
    ViewData["Title"] = "UN Sacco - Empowering Members Financially";
}

@section Styles {
    <!-- Main dashboard styles -->
    <link href="~/custom/dashboard/css/dashboard-home.css" rel="stylesheet" asp-append-version="true" />
}

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">
        Dashboard
    </h1>
    <p class="page-subtitle">
        Welcome back! Here's what's happening with your account today.
    </p>
</div>

@if (!string.IsNullOrWhiteSpace(ViewBag.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
        <h6 class="alert-heading"><i class="me-2">⚠️</i>Dashboard Error</h6>
        <p class="mb-0">@ViewBag.ErrorMessage</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Main Dashboard Row -->
<div class="dashboard-main-row">
    <div class="row g-3">

        <!-- Right Side: Quick Actions (unchanged) -->
        <div class="col">
            <div class="quick-actions-card">
                <div class="actions-header">
                    <h6 class="actions-title">
                        <i class="actions-icon">⚡</i>
                        Quick Actions
                    </h6>
                </div>
                <div class="actions-grid-wrapper">
                    <div class="actions-grid">
                        <a asp-controller="Leave" asp-action="ApplyForLeave" class="action-item">
                            <div class="action-icon bg-primary">
                                <i class="icon">📝</i>
                            </div>
                            <div class="action-text-container">
                                <span class="action-text">Apply for Leave</span>
                                <span class="action-subtext">Submit new application</span>
                            </div>
                        </a>

                        <a href="/Payroll/GetRecentPayslip" class="action-item">
                            <div class="action-icon bg-success">
                                <i class="icon">📄</i>
                            </div>
                            <div class="action-text-container">
                                <span class="action-text">Download Payslip</span>
                                <span class="action-subtext">Get salary statement</span>
                            </div>
                        </a>

                        <a href="/Payroll/GetRecentP9" class="action-item">
                            <div class="action-icon bg-info">
                                <i class="icon">📊</i>
                            </div>
                            <div class="action-text-container">
                                <span class="action-text">P9 Certificate</span>
                                <span class="action-subtext">Tax certificate</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- NEW: Compact Leave Balance Overview Section -->
@if (Model.LeaveSummaryViewModel?.LeaveTypeRows.Any() == true)
{
    <div class="leave-balance-overview-section">
        <div class="form-card">
            <div class="form-card-header">
                <h3 class="form-card-title">
                    <i class="form-card-icon">📊</i>
                    Leave Statistics Overview
                </h3>
                <div class="form-card-subtitle">
                    Your current leave entitlements and balances across all leave types
                </div>
            </div>
            <div class="form-card-body">
                <table class="leave-balance-table">
                    <thead class="leave-balance-header">
                        <tr>
                            <th>Leave Type</th>
                            <th>Entitlement</th>
                            <th>Brought Forward</th>
                            <th>Used</th>
                            <th>Balance</th>
                            <th>Usage</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in Model.LeaveSummaryViewModel.LeaveTypeRows)
                        {
                            <tr class="leave-type-row @row.RowCssClass">
                                <td data-label="Leave Type">
                                    <div class="leave-type-cell">
                                        @* <h6 class="leave-type-name">@row.LeaveType</h6> *@
                                        <span class="leave-type-badge @row.LeaveCode.ToLowerInvariant()">@row.LeaveCode</span>
                                    </div>
                                </td>
                                <td data-label="Entitlement">
                                    <span class="stat-value">@row.AnnualEntitlementText days</span>
                                </td>
                                <td data-label="Brought Forward">
                                    @if (row.HasBroughtForward)
                                    {
                                        <span class="stat-value text-success">+@row.BroughtForwardText days</span>
                                    }
                                    else
                                    {
                                        <span class="stat-value">-</span>
                                    }
                                </td>
                                <td data-label="Used">
                                    @if (row.HasBeenUsed)
                                    {
                                        <span class="stat-value @row.TakenDisplayClass">@row.TakenText days</span>
                                    }
                                    else
                                    {
                                        <span class="stat-value">-</span>
                                    }
                                </td>
                                <td data-label="Balance">
                                    <span class="stat-value balance-cell @row.BalanceDisplayClass">@row.TotalBalanceText days</span>
                                </td>
                                <td data-label="Usage">
                                    <div class="usage-cell">
                                        @if (row.UsagePercentage > 0)
                                        {
                                            <div class="usage-progress">
                                                <div class="usage-progress-bar @row.UsageProgressClass"
                                                     style="width: @row.UsageProgressValue%">
                                                </div>
                                            </div> 
                                        }
                                        <span class="usage-text">@row.UsagePercentage% used</span>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}


<!-- Leave History Section -->
<div class="leave-history-card">
    <div class="leave-history-header">
        <h5 class="leave-history-title">
            <i class="icon">📊</i>
            Leave History
        </h5>
        <a asp-action="LeaveHistory" asp-controller="Leave" class="view-all-link">View All</a>
    </div>

    @if (Model.HasLeaveHistory)
    {
        <div class="leave-history-content">
            <div class="leave-list">
                @foreach (var item in Model.LeaveHistory.OrderByDescending(lh => lh.ApplicationNo).Take(5))
                {
                    <div class="leave-item" data-application-no="@item.ApplicationNo">
                        <div class="leave-content">
                            <div class="leave-main-info">
                                <h6 class="leave-type">@item.LeaveType</h6>
                                <div class="leave-inline-details">
                                    <span class="leave-dates">@item.DurationText</span>
                                    <span class="meta-item">
                                        <i class="meta-icon">📅</i>
                                        @item.DaysApplied day@(item.DaysApplied != 1 ? "s" : "")
                                    </span>
                                    <span class="meta-item">
                                        <i class="meta-icon">🔢</i>
                                        @item.ApplicationNo
                                    </span>
                                    <span class="meta-item">
                                        <i class="meta-icon">📋</i>
                                        @item.LeavePeriod
                                    </span>
                                </div>
                            </div>
                            <div class="leave-status-actions">
                                <span class="status-badge @item.StatusCssClass">@item.StatusDisplayText</span>
                                <button class="btn btn-outline-primary btn-sm view-leave-btn"
                                        data-application-no="@item.ApplicationNo"
                                        onclick="loadLeaveDetailModal('@item.ApplicationNo')">
                                    <i class="btn-icon">👁️</i>
                                    View
                                </button>
                                
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (Model.LeaveHistory.Count > 5)
            {
                <div class="leave-history-footer">
                    <p class="text-muted text-center">
                        Showing @Model.LeaveHistory.Take(5).Count() of @Model.LeaveHistory.Count applications
                    </p>
                </div>
            }

        </div>
        
    }
    else
    {
        <div class="no-leave-content">
            <i class="no-leave-icon">🏖️</i>
            <h6>No Leave Applications</h6>
            <p class="no-leave-text">You haven't applied for any leave yet.</p>

            @if (Model.AnnualLeaveSummary?.CurrentBalance > 0)
            {
                <span class="leave-balance">
                    <i class="icon">💰</i>
                    @Model.CurrentBalance days available
                </span>
            }

            <a class="btn btn-sm btn-primary apply-leave-btn" asp-controller="Leave" asp-action="ApplyForLeave">
                <i class="icon">📝</i>
                Apply for Leave
            </a>
        </div>
    }
</div>

<!-- Dynamic Modal Container -->
<div id="dynamicModalContainer"></div>

@section Scripts {

    <script src="~/custom/dashboard/js/dashboard-modals.js" asp-append-version="true"></script>

    <script>
        // Set current date
        document.addEventListener('DOMContentLoaded', function() {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                const today = new Date();
                dateElement.textContent = today.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }
        });

        // View leave details functionality
        document.addEventListener('DOMContentLoaded', function() {

            const viewBtns = document.querySelectorAll('.view-leave-btn');

            // Set current date if element exists
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                const today = new Date();
                dateElement.textContent = today.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }

        });

        // Notification helper
        function showNotification(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' :
                              type === 'error' ? 'alert-danger' : 'alert-info';

            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        window.loadLeaveDetailModal = function(applicationNo) {
            console.log('Loading leave detail modal for:', applicationNo);

            if (typeof DashboardModals !== 'undefined') {
                DashboardModals.loadLeaveDetailModal(applicationNo);
            } else {
                // Fallback if DashboardModals not available
                console.error('DashboardModals not available, redirecting...');
                window.location.href = `/Leave/LeaveDetailModal?applicationNo=${applicationNo}`;
            }
        };

    </script>

}

